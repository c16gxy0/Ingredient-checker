<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Furship Recipe Part Scaler</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color-scheme: light dark;
  }
  body {
    margin: 0;
    padding: 1.25rem;
    line-height: 1.4;
    background: canvas;
    color: canvastext;
  }
  h1 {
    margin: 0 0 1rem;
    font-size: 1.2rem;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    max-width: 520px;
  }
  th, td {
    padding: .5rem .55rem;
    border-bottom: 1px solid rgba(0,0,0,.15);
    font-size: .9rem;
  }
  th {
    text-align: left;
    font-size: .65rem;
    text-transform: uppercase;
    letter-spacing: .07em;
    opacity: .7;
  }
  tbody tr.driver {
    background: #ffe9b5;
    color: #222;
  }
  @media (prefers-color-scheme: dark) {
    tbody tr.driver {
      background: #4b3b10;
      color: #f9e7c0;
    }
    th, td { border-color: #333; }
  }
  input[type=number], input[type=text] {
    width: 100%;
    box-sizing: border-box;
    padding: .35rem .4rem;
    font-size: .9rem;
  }
  .small-note {
    font-size: .7rem;
    margin-top: .75rem;
    max-width: 520px;
    opacity: .8;
  }
  .row-inline {
    display: flex;
    gap: .75rem;
    flex-wrap: wrap;
    align-items: center;
    margin: 1rem 0 .5rem;
    max-width: 520px;
  }
  .add-inline {
    display: grid;
    grid-template-columns: 1fr 120px 100px;
    gap: .5rem;
    align-items: end;
    margin: .9rem 0;
    max-width: 520px;
  }
  label {
    display: block;
    font-size: .7rem;
    opacity: .8;
    margin-bottom: .25rem;
  }
  button {
    padding: .45rem .8rem;
    font-size: .7rem;
    text-transform: uppercase;
    letter-spacing: .05em;
    border: 1px solid #999;
    background: #eee;
    cursor: pointer;
  }
  @media (prefers-color-scheme: dark) {
    button {
      background: #2d3136;
      color: #f2f2f2;
      border-color: #555;
    }
  }
  .parts-input { width: 90px; }
  .amount-input { width: 120px; }

  /* Inline remove button inside Item column */
  .item-cell {
    display: flex;
    align-items: center;
    gap: .4rem;
  }
  .remove-btn {
    min-width: 1.6rem;
    height: 1.6rem;
    padding: 0;
    border-radius: 999px;
    border: 1px solid #999;
    background: #f2f2f2;
    color: #222;
    line-height: 1.6rem;
    text-align: center;
    font-weight: 700;
    font-size: .9rem;
    cursor: pointer;
  }
  .remove-btn:hover {
    background: #ffd9d9;
    border-color: #e08c8c;
  }
  @media (prefers-color-scheme: dark) {
    .remove-btn {
      background: #38404a;
      color: #f6f6f6;
      border-color: #555;
    }
    .remove-btn:hover {
      background: #5a2f2f;
      border-color: #8a4b4b;
    }
  }
</style>
</head>
<body>
  <h1>Furship Recipe Part Scaler</h1>

  <div class="row-inline">
    <button id="resetBtn">Reset</button>
    <label style="font-size:.8rem; display:flex; gap:.4rem; align-items:center;">
      Rounding
      <select id="rounding" style="font-size:.8rem; padding:.2rem .3rem;">
        <option value="none">None</option>
        <option value="0">0</option>
        <option value="1">0.1</option>
        <option value="2" selected>0.01</option>
      </select>
    </label>
    <span id="scaleInfo" style="font-size:.8rem; opacity:.75;"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:45%;">Item</th>
        <th style="width:25%;">Parts</th>
        <th style="width:30%;">Amount</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <!-- rows created once or appended, then updated in-place -->
    </tbody>
  </table>

  <div class="add-inline">
    <div>
      <label for="newName">Add item</label>
      <input id="newName" type="text" placeholder="New item name" />
    </div>
    <div>
      <label for="newParts">Parts</label>
      <input id="newParts" type="number" step="0.0001" min="0.0001" placeholder="e.g. 10" />
    </div>
    <div>
      <button id="addBtn" type="button">Add</button>
    </div>
  </div>

  <div class="small-note">
    Type a number in one Amount cell (grams, ml, etc.). That row becomes the active scaler and all others update:
    amount_i = parts_i × (active_amount / active_parts).
    Clear the active cell to stop scaling. You can keep typing—no re-rendering happens while you type.
  </div>

<script>
(function() {
  // --- Editable initial recipe ---
  const initialData = [
    { name: 'Chicken', parts: 50 },
    { name: 'Cream Cheese', parts: 23 },
    { name: 'Oat Flour', parts: 17 }
  ];

  // --- State ---
  let rows = [];
  let driverIndex = null;

  const tbody = document.getElementById('tbody');
  const roundingSelect = document.getElementById('rounding');
  const scaleInfo = document.getElementById('scaleInfo');
  const resetBtn = document.getElementById('resetBtn');

  // Add-new controls
  const newName = document.getElementById('newName');
  const newParts = document.getElementById('newParts');
  const addBtn = document.getElementById('addBtn');

  // Cached element refs for in-place updates
  let rowEls = []; // [{tr, nameInput, partsInput, amountInput}...]

  function cloneInitial() {
    rows = initialData.map(r => ({
      name: r.name,
      parts: r.parts,
      amount: '' // user enters
    }));
    driverIndex = null;
  }

  function buildRowHTML(i) {
    const r = rows[i];
    return `<tr data-i="${i}">
      <td>
        <div class="item-cell">
          <input type="text" data-field="name" value="${escapeHtml(r.name)}" />
          <button type="button" class="remove-btn" data-action="remove" title="Remove this item" aria-label="Remove">×</button>
        </div>
      </td>
      <td>
        <input type="number" class="parts-input" step="0.0001" min="0.0001"
          data-field="parts" value="${r.parts}" />
      </td>
      <td>
        <input type="number" class="amount-input" step="0.0001"
          data-field="amount" value="${rows[i].amount === '' ? '' : rows[i].amount}" />
      </td>
    </tr>`;
  }

  function buildTableOnce() {
    tbody.innerHTML = rows.map((_, i) => buildRowHTML(i)).join('');
    cacheRowEls();
  }

  function appendOneRow(i) {
    tbody.insertAdjacentHTML('beforeend', buildRowHTML(i));
    const tr = tbody.querySelector('tr:last-child');
    rowEls.push({
      tr,
      nameInput: tr.querySelector('input[data-field="name"]'),
      partsInput: tr.querySelector('input[data-field="parts"]'),
      amountInput: tr.querySelector('input[data-field="amount"]')
    });
  }

  function cacheRowEls() {
    rowEls = Array.from(tbody.querySelectorAll('tr')).map(tr => {
      return {
        tr,
        nameInput: tr.querySelector('input[data-field="name"]'),
        partsInput: tr.querySelector('input[data-field="parts"]'),
        amountInput: tr.querySelector('input[data-field="amount"]')
      };
    });
  }

  function rebuildIndicesAndCache() {
    const trs = Array.from(tbody.querySelectorAll('tr'));
    trs.forEach((tr, idx) => tr.setAttribute('data-i', idx));
    cacheRowEls();
  }

  function escapeHtml(str) {
    return (str+'').replace(/[&<>"']/g, s => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[s]));
  }

  function roundingFn() {
    const mode = roundingSelect.value;
    if (mode === 'none') return v => v;
    const decimals = Number(mode);
    return v => Number(v.toFixed(decimals));
  }

  function updateDriverHighlight() {
    rowEls.forEach((el, i) => {
      if (i === driverIndex) {
        el.tr.classList.add('driver');
      } else {
        el.tr.classList.remove('driver');
      }
    });
  }

  function recomputeFromDriver() {
    if (driverIndex == null) {
      scaleInfo.textContent = '';
      return;
    }
    const driver = rows[driverIndex];
    const driverEl = rowEls[driverIndex];

    const raw = driverEl.amountInput.value;
    const num = Number(raw);
    if (!isFinite(num) || num <= 0 || driver.parts <= 0) {
      scaleInfo.textContent = '';
      return;
    }

    driver.amount = num;

    const scale = num / driver.parts;
    const round = roundingFn();

    rows.forEach((r, i) => {
      if (i === driverIndex) return;
      const needed = r.parts * scale;
      r.amount = round(needed);
      rowEls[i].amountInput.value = r.amount;
    });

    scaleInfo.textContent = 'Scale: ' + formatNumber(scale, round);
  }

  function formatNumber(v, fn) {
    if (!isFinite(v)) return '';
    return fn(v);
  }

  // Event delegation (no full re-render)
  tbody.addEventListener('input', e => {
    const tr = e.target.closest('tr');
    if (!tr) return;
    const i = Number(tr.getAttribute('data-i'));
    const field = e.target.getAttribute('data-field');
    const row = rows[i];

    if (field === 'name') {
      row.name = e.target.value;
      return;
    }

    if (field === 'parts') {
      const val = Number(e.target.value);
      if (isFinite(val) && val > 0) {
        row.parts = val;
        if (driverIndex != null) recomputeFromDriver();
      }
      return;
    }

    if (field === 'amount') {
      const raw = e.target.value;

      if (raw === '') {
        if (i === driverIndex) {
          driverIndex = null;
          updateDriverHighlight();
          scaleInfo.textContent = '';
        }
        rows[i].amount = '';
        return;
      }

      const num = Number(raw);
      if (isFinite(num) && num > 0) {
        driverIndex = i;
        updateDriverHighlight();
        recomputeFromDriver();
      }
      return;
    }
  });

  // Remove button click (event delegation)
  tbody.addEventListener('click', e => {
    const btn = e.target.closest('[data-action="remove"]');
    if (!btn) return;
    const tr = btn.closest('tr');
    if (!tr) return;
    const i = Number(tr.getAttribute('data-i'));

    // Update state
    rows.splice(i, 1);
    // Remove DOM row
    tr.remove();

    // Adjust driver index
    if (driverIndex === null) {
      // nothing
    } else if (i === driverIndex) {
      driverIndex = null;
      scaleInfo.textContent = '';
    } else if (i < driverIndex) {
      driverIndex -= 1;
    }

    // Re-index and refresh caches/highlights
    rebuildIndicesAndCache();
    updateDriverHighlight();

    // Recompute if a driver still exists
    if (driverIndex != null) recomputeFromDriver();
  });

  roundingSelect.addEventListener('change', () => {
    if (driverIndex != null) {
      recomputeFromDriver();
    }
  });

  resetBtn.addEventListener('click', () => {
    if (!confirm('Reset to original example?')) return;
    cloneInitial();
    buildTableOnce();
    updateDriverHighlight();
    scaleInfo.textContent = '';
  });

  // Add new item
  addBtn.addEventListener('click', () => {
    const name = newName.value.trim();
    const parts = Number(newParts.value);
    if (!name || !isFinite(parts) || parts <= 0) {
      alert('Please provide a name and a positive parts value.');
      return;
    }
    const idx = rows.length;
    rows.push({ name, parts, amount: '' });
    appendOneRow(idx);
    rebuildIndicesAndCache(); // keep indices consistent (append case is already fine, but safe)
    if (driverIndex != null) {
      recomputeFromDriver();
    }
    newName.value = '';
    newParts.value = '';
    newName.focus();
  });

  // Enter to add
  newName.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      newParts.focus();
    }
  });
  newParts.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addBtn.click();
    }
  });

  // Init
  cloneInitial();
  buildTableOnce();
  updateDriverHighlight();
})();
</script>
</body>
</html>
