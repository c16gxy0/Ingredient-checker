<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Simple Recipe Part Scaler</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color-scheme: light dark;
  }
  body {
    margin: 0;
    padding: 1.25rem;
    line-height: 1.4;
    background: canvas;
    color: canvastext;
  }
  h1 {
    margin: 0 0 1rem;
    font-size: 1.2rem;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    max-width: 520px;
  }
  th, td {
    padding: .5rem .55rem;
    border-bottom: 1px solid rgba(0,0,0,.15);
    font-size: .9rem;
  }
  th {
    text-align: left;
    font-size: .65rem;
    text-transform: uppercase;
    letter-spacing: .07em;
    opacity: .7;
  }
  tbody tr.driver {
    background: #ffe9b5;
    color: #222;
  }
  @media (prefers-color-scheme: dark) {
    tbody tr.driver {
      background: #4b3b10;
      color: #f9e7c0;
    }
    th, td { border-color: #333; }
  }
  input[type=number], input[type=text] {
    width: 100%;
    box-sizing: border-box;
    padding: .35rem .4rem;
    font-size: .9rem;
  }
  .small-note {
    font-size: .7rem;
    margin-top: .75rem;
    max-width: 520px;
    opacity: .8;
  }
  .row-inline {
    display: flex;
    gap: .75rem;
    flex-wrap: wrap;
    align-items: center;
    margin: 1rem 0 .5rem;
    max-width: 520px;
  }
  button {
    padding: .45rem .8rem;
    font-size: .7rem;
    text-transform: uppercase;
    letter-spacing: .05em;
    border: 1px solid #999;
    background: #eee;
    cursor: pointer;
  }
  @media (prefers-color-scheme: dark) {
    button {
      background: #2d3136;
      color: #f2f2f2;
      border-color: #555;
    }
  }
  .parts-input { width: 90px; }
  .amount-input { width: 120px; }
  .driver-indicator {
    font-size: .55rem;
    padding: .15rem .4rem;
    border-radius: 1rem;
    background: #222;
    color: #fff;
    margin-left: .4rem;
    letter-spacing: .06em;
    display: inline-block;
  }
  @media (prefers-color-scheme: dark) {
    .driver-indicator { background:#111; color:#f6f6f6; }
  }
</style>
</head>
<body>
  <h1>Simple Recipe Part Scaler</h1>

  <div class="row-inline">
    <button id="resetBtn">Reset</button>
    <label style="font-size:.8rem; display:flex; gap:.4rem; align-items:center;">
      Rounding
      <select id="rounding" style="font-size:.8rem; padding:.2rem .3rem;">
        <option value="none">None</option>
        <option value="0">0</option>
        <option value="1">0.1</option>
        <option value="2" selected>0.01</option>
      </select>
    </label>
    <span id="scaleInfo" style="font-size:.8rem; opacity:.75;"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:45%;">Item</th>
        <th style="width:25%;">Parts</th>
        <th style="width:30%;">Amount</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <!-- rows created once, then updated in-place -->
    </tbody>
  </table>

  <div class="small-note">
    Type a number in one Amount cell (grams, ml, etc.). That row becomes the driver and all others scale automatically:
    amount_i = parts_i * (driver_amount / driver_parts).
    Clear the driver cell to stop scaling. You can keep typingâ€”no re-rendering happens while you type.
  </div>

<script>
(function() {
  // --- Editable initial recipe ---
  const initialData = [
    { name: 'Chicken', parts: 50 },
    { name: 'Cream Cheese', parts: 23 },
    { name: 'Oat Flour', parts: 17 }
  ];

  // --- State ---
  let rows = [];
  let driverIndex = null;

  const tbody = document.getElementById('tbody');
  const roundingSelect = document.getElementById('rounding');
  const scaleInfo = document.getElementById('scaleInfo');
  const resetBtn = document.getElementById('resetBtn');

  // Cached element refs for in-place updates
  let rowEls = []; // [{tr, nameInput, partsInput, amountInput, badge}...]

  function cloneInitial() {
    rows = initialData.map(r => ({
      name: r.name,
      parts: r.parts,
      amount: '' // user enters
    }));
    driverIndex = null;
  }

  function buildTableOnce() {
    // Build rows HTML once
    tbody.innerHTML = rows.map((r,i) => {
      return `<tr data-i="${i}">
        <td>
          <input type="text" data-field="name" value="${escapeHtml(r.name)}" />
          <span class="driver-indicator" data-role="badge" hidden>DRIVER</span>
        </td>
        <td>
          <input type="number" class="parts-input" step="0.0001" min="0.0001"
            data-field="parts" value="${r.parts}" />
        </td>
        <td>
          <input type="number" class="amount-input" step="0.0001"
            data-field="amount" value="${rows[i].amount === '' ? '' : rows[i].amount}" />
        </td>
      </tr>`;
    }).join('');

    // Cache refs
    rowEls = Array.from(tbody.querySelectorAll('tr')).map(tr => {
      return {
        tr,
        nameInput: tr.querySelector('input[data-field="name"]'),
        partsInput: tr.querySelector('input[data-field="parts"]'),
        amountInput: tr.querySelector('input[data-field="amount"]'),
        badge: tr.querySelector('[data-role="badge"]')
      };
    });
  }

  function escapeHtml(str) {
    return (str+'').replace(/[&<>"']/g, s => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[s]));
  }

  function roundingFn() {
    const mode = roundingSelect.value;
    if (mode === 'none') return v => v;
    const decimals = Number(mode);
    return v => Number(v.toFixed(decimals));
  }

  function updateDriverHighlight() {
    rowEls.forEach((el, i) => {
      if (i === driverIndex) {
        el.tr.classList.add('driver');
        el.badge.hidden = false;
      } else {
        el.tr.classList.remove('driver');
        el.badge.hidden = true;
      }
    });
  }

  function recomputeFromDriver() {
    if (driverIndex == null) {
      scaleInfo.textContent = '';
      return;
    }
    const driver = rows[driverIndex];
    const driverEl = rowEls[driverIndex];

    const raw = driverEl.amountInput.value;
    const num = Number(raw);
    if (!isFinite(num) || num <= 0 || driver.parts <= 0) {
      scaleInfo.textContent = '';
      return;
    }

    // Update state for driver
    driver.amount = num;

    const scale = num / driver.parts;
    const round = roundingFn();

    rows.forEach((r, i) => {
      if (i === driverIndex) return;
      const needed = r.parts * scale;
      r.amount = round(needed);
      rowEls[i].amountInput.value = r.amount;
    });

    scaleInfo.textContent = 'Scale: ' + formatNumber(scale, round);
  }

  function formatNumber(v, fn) {
    if (!isFinite(v)) return '';
    return fn(v);
  }

  // Event delegation (no full re-render)
  tbody.addEventListener('input', e => {
    const tr = e.target.closest('tr');
    if (!tr) return;
    const i = Number(tr.getAttribute('data-i'));
    const field = e.target.getAttribute('data-field');
    const row = rows[i];

    if (field === 'name') {
      row.name = e.target.value;
      return;
    }

    if (field === 'parts') {
      const val = Number(e.target.value);
      if (isFinite(val) && val > 0) {
        row.parts = val;
        if (driverIndex != null) recomputeFromDriver();
      }
      return;
    }

    if (field === 'amount') {
      const raw = e.target.value;

      if (raw === '') {
        if (i === driverIndex) {
          driverIndex = null;
          updateDriverHighlight();
          scaleInfo.textContent = '';
        }
        rows[i].amount = '';
        return;
      }

      const num = Number(raw);
      if (isFinite(num) && num > 0) {
        driverIndex = i;
        updateDriverHighlight();
        recomputeFromDriver();
      }
      return;
    }
  });

  roundingSelect.addEventListener('change', () => {
    if (driverIndex != null) {
      recomputeFromDriver();
    }
  });

  resetBtn.addEventListener('click', () => {
    if (!confirm('Reset to original example?')) return;
    cloneInitial();
    buildTableOnce();
    updateDriverHighlight();
    scaleInfo.textContent = '';
  });

  // Init
  cloneInitial();
  buildTableOnce();
  updateDriverHighlight();
})();
</script>
</body>
</html>